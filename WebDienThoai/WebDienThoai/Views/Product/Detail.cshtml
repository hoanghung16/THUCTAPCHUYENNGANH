@model WebDienThoai.Models.Product
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = Model.Name;

    // Tính % giảm giá để hiển thị Badge
    int discountPercent = 0;
    if (Model.IsOnSale && Model.Price > 0 && Model.Saleprice.HasValue)
    {
        discountPercent = (int)Math.Round((1 - (Model.Saleprice.Value / Model.Price)) * 100);
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/detail.css" />
}

<div class="breadcrumb-area">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/" class="text-muted text-decoration-none">Trang chủ</a></li>
                <li class="breadcrumb-item">
                    <a asp-controller="Product" asp-action="Category" asp-route-categoryName="@(Model.Category?.Slug ?? "")" class="text-muted text-decoration-none">
                        @(Model.Category?.Name ?? "Sản phẩm")
                    </a>
                </li>
                <li class="breadcrumb-item active text-dark fw-bold">@Model.Name</li>
            </ol>
        </nav>
    </div>
</div>

<main class="product-detail-container">
    <div class="container">
        <div class="row">

            <div class="col-lg-6">
                <div class="product-gallery header-anim">
                    @if (discountPercent > 0)
                    {
                        <div class="detail-sale-badge">-@discountPercent%</div>
                    }
                    <img src="@Model.ImageUrl" alt="@Model.Name" id="mainImage">
                </div>
            </div>

            <div class="col-lg-6">
                <div class="product-info header-anim">
                    <span class="brand-tag">@Model.Category?.Name</span>
                    <h1>@Model.Name</h1>

                    <div class="mb-3 text-warning small">
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill"></i>
                        <span class="text-muted ms-2">(5.0 đánh giá)</span>
                    </div>

                    <div class="price-wrapper">
                        @if (Model.IsOnSale == true && Model.Saleprice.HasValue)
                        {
                            <span class="current-price">@Model.Saleprice.Value.ToString("N0")đ</span>
                            <span class="old-price">@Model.Price.ToString("N0")đ</span>
                        }
                        else
                        {
                            <span class="current-price">@Model.Price.ToString("N0")đ</span>
                        }
                    </div>

                    <form asp-controller="Cart" asp-action="AddToCart" method="post" onsubmit="return checkLogin(event)">
                        <input type="hidden" name="id" value="@Model.Id" />

                        <div class="qty-control">
                            <span class="qty-label">Số lượng:</span>
                            <div class="qty-input-group">
                                <button type="button" class="qty-btn" onclick="changeQty(-1)">-</button>
                                <input type="text" name="quantity" id="quantity" value="1" class="qty-input" readonly>
                                <button type="button" class="qty-btn" onclick="changeQty(1)">+</button>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="submit" class="btn btn-add-cart">
                                <i class="bi bi-cart-plus me-2"></i> THÊM VÀO GIỎ
                            </button>
                            <button type="button" class="btn btn-buy-now">
                                MUA NGAY
                            </button>
                        </div>
                    </form>

                    <div class="service-badges">
                        <div class="row">
                            <div class="col-6 service-item"><i class="bi bi-shield-check text-success"></i> Bảo hành 12 tháng</div>
                            <div class="col-6 service-item"><i class="bi bi-arrow-repeat text-primary"></i> 1 đổi 1 trong 30 ngày</div>
                            <div class="col-6 service-item"><i class="bi bi-truck text-warning"></i> Miễn phí vận chuyển</div>
                            <div class="col-6 service-item"><i class="bi bi-box-seam text-danger"></i> Kiểm tra hàng trước</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="product-tabs-section">
            <ul class="nav nav-tabs custom-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc" type="button">Mô tả sản phẩm</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#specs" type="button">Thông số kỹ thuật</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#review" type="button">Đánh giá</button>
                </li>
            </ul>

            <div class="tab-content pt-4" id="myTabContent">
                <div class="tab-pane fade show active" id="desc">
                    <div class="tab-content-text">
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <div style="white-space: pre-line;">@Model.Description</div>
                        }
                        else
                        {
                            <p class="text-center text-muted">Thông tin mô tả đang được cập nhật...</p>
                        }
                    </div>
                </div>

                <div class="tab-pane fade" id="specs">
                    <p class="text-center text-muted py-4">Thông số kỹ thuật chi tiết đang cập nhật.</p>
                </div>

                <div class="tab-pane fade" id="review">
                    <p class="text-center text-muted py-4">Chưa có đánh giá nào cho sản phẩm này.</p>
                </div>
            </div>
        </div>

        <div class="related-products-section">
            <h3 class="section-heading">SẢN PHẨM TƯƠNG TỰ <span></span></h3>

            @{
                var related = ViewBag.RelatedProducts as IEnumerable<WebDienThoai.Models.Product>;
            }

            @if (related != null && related.Any())
            {
                <div class="related-grid">
                    @foreach (var item in related)
                    {
                        // Tính giá sale cho item con
                        int discount = 0;
                        if (item.IsOnSale && item.Price > 0 && item.Saleprice.HasValue)
                        {
                            discount = (int)Math.Round((1 - (item.Saleprice.Value / item.Price)) * 100);
                        }

                        <div class="product-card h-100 d-flex flex-column" style="background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; position: relative; transition: transform 0.3s;">

                            <a href="/Product/Detail/@item.Id" class="d-block text-center mb-3">
                                <img src="@item.ImageUrl" alt="@item.Name" style="height: 180px; width: 100%; object-fit: contain;">
                            </a>

                            <p class="fw-bold text-dark mb-2" style="font-size: 15px; min-height: 44px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                @item.Name
                            </p>

                            <div class="mt-auto">
                                @if (item.IsOnSale)
                                {
                                    <div class="fw-bold text-danger">@((item.Saleprice ?? 0).ToString("N0"))đ</div>
                                    <small class="text-muted text-decoration-line-through">@item.Price.ToString("N0")đ</small>

                                    <div style="position: absolute; top: 10px; left: 10px; background: #dc3545; color: white; padding: 2px 6px; font-size: 11px; font-weight: bold; border-radius: 3px;">
                                        -@discount%
                                    </div>
                                }
                                else
                                {
                                    <div class="fw-bold text-dark">@item.Price.ToString("N0")đ</div>
                                }

                                <a href="/Product/Detail/@item.Id" class="btn btn-sm btn-outline-dark w-100 mt-3 text-uppercase fw-bold">Xem Chi Tiết</a>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-center text-muted">Không có sản phẩm tương tự.</p>
            }
        </div>

    </div>
</main>

@section Scripts {
    <script>
        // 1. Tăng giảm số lượng
        function changeQty(amount) {
            const input = document.getElementById('quantity');
            let val = parseInt(input.value) + amount;
            if (val >= 1 && val <= 10) input.value = val;
        }

        // 2. Kiểm tra đăng nhập
        function checkLogin(e) {
            const isLoggedIn = @((Context.Session.GetString("Username") != null).ToString().ToLower());

            if (!isLoggedIn) {
                e.preventDefault();
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: "Bạn cần đăng nhập để mua hàng!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#333',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Đăng nhập',
                        cancelButtonText: 'Đóng'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/Account/Login';
                        }
                    });
                } else {
                    if(confirm("Bạn cần đăng nhập để mua hàng. Chuyển đến trang đăng nhập?")) {
                        window.location.href = '/Account/Login';
                    }
                }
                return false;
            }
            return true;
        }

        // 3. HIỆU ỨNG ANIME.JS (Cập nhật mới)
        document.addEventListener('DOMContentLoaded', () => {
             if (typeof anime !== 'undefined') {

                 // Hiệu ứng Header & Ảnh chính
                 anime({
                    targets: '.header-anim',
                    translateY: [20, 0],
                    opacity: [0, 1],
                    easing: 'easeOutExpo',
                    duration: 1000,
                    delay: anime.stagger(100)
                });

              
                const relatedCards = document.querySelectorAll('.related-grid .product-card');
                if (relatedCards.length > 0) {
                   
                    const observer = new IntersectionObserver((entries) => {
                        if(entries[0].isIntersecting) {
                            anime({
                                targets: relatedCards,
                                translateY: [30, 0],
                                opacity: [0, 1], // Hiện hình
                                scale: [0.9, 1],
                                easing: 'easeOutQuad',
                                duration: 800,
                                delay: anime.stagger(100)
                            });
                            observer.disconnect(); // Chạy 1 lần rồi thôi
                        }
                    }, { threshold: 0.1 }); // Hiện khi thấy 10% khung hình

                    observer.observe(document.querySelector('.related-products-section'));
                }
            } else {
                // Fallback: Nếu thư viện Anime.js lỗi, tự động hiện sản phẩm
                document.querySelectorAll('.product-card').forEach(el => el.style.opacity = 1);
            }
        });
    </script>
}